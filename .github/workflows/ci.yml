name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # Обновлено

    - name: Set up Python
      uses: actions/setup-python@v5  # Обновлено
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run code style checks (PEP8, flake8)
      if: github.event_name == 'push'
      run: |
        pytest tests/ -v

    - name: Run prediction and generate artifacts
      if: github.event_name == 'pull_request'
      run: |
        # Обучаем модель
        mkdir -p models
        python -c "
from src.model import train_and_save_model; 
train_and_save_model()
"

        # Генерируем предсказания
        python -c "
import pandas as pd
from src.model import load_model, predict_risk
from src.utils import save_predictions

# Загружаем данные
df = pd.read_csv('data/input.csv')
X = df[['attendance_rate', 'avg_grade', 'missed_assignments', 'login_frequency']]

# Загружаем модель
model = load_model()
risks = predict_risk(model, X)

# Сохраняем результат
save_predictions(df['name'].tolist(), risks, 'artifacts/output.csv')
"

        # Создаём папку артефактов, если не существует
        mkdir -p artifacts

    - name: Upload artifacts
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4  # ✅ Исправлено: v4 вместо v3
      with:
        name: prediction-output
        path: |
          artifacts/output.csv
          models/logistic_regression_model.pkl
        retention-days: 7
