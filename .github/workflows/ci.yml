name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Установка Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Установка зависимостей
      run: |
        pip install -r requirements.txt

    - name: Запуск тестов (PEP8, flake8, API)
      run: |
        export PYTHONPATH='.'
        pytest tests/ -v

    - name: Генерация артефактов при PR
      if: github.event_name == 'pull_request'
      run: |
        export PYTHONPATH='.'
        mkdir -p models
        mkdir -p artifacts
        python -c "from src.model import train_and_save_model; train_and_save_model()"
        python -c "
        from src.model import load_model, predict_risk
        import pandas as pd
        model = load_model()
        df = pd.read_csv('data/input.csv')
        X = df[['attendance_rate', 'avg_grade', 'missed_assignments', 'login_frequency']]
        risks = predict_risk(model, X)
        df_result = df[['name']].copy()
        df_result['dropout_risk'] = risks
        df_result.to_csv('artifacts/output.csv', index=False)
        "
        cp models/logistic_regression_model.pkl artifacts/ 2>/dev/null || echo "Модель будет обучена при запуске"

    - name: Загрузка артефактов
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: prediction-output
        path: artifacts/
